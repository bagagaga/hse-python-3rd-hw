# Руководство по тестированию URL Shortener

В этом документе описывается, как запускать различные тесты для приложения URL Shortener и интерпретировать их результаты.

## Содержание

1. [Модульные тесты](#модульные-тесты)
2. [Функциональные тесты](#функциональные-тесты)
3. [Нагрузочные тесты](#нагрузочные-тесты)
4. [Покрытие кода тестами](#покрытие-кода-тестами)

## Модульные тесты

Модульные тесты проверяют отдельные компоненты приложения в изоляции.

### Запуск модульных тестов

```bash
# Запуск всех модульных тестов
python -m pytest tests/unit/ -v

# Запуск конкретного теста
python -m pytest tests/unit/test_link_utils.py -v
```

Модульные тесты охватывают:
- Функции утилиты для ссылок (генерация коротких кодов, обработка истечения срока действия)
- Поведение моделей (инициализация, отношения)

## Функциональные тесты

Функциональные тесты проверяют поведение API через интеграционное тестирование.

### Запуск функциональных тестов

```bash
# Запуск всех функциональных тестов
python -m pytest tests/functional/ -v

# Запуск конкретного теста
python -m pytest tests/functional/test_links.py -v
```

Функциональные тесты охватывают:
- Процессы аутентификации (регистрация, вход)
- CRUD операции с ссылками
- Контроль доступа и разрешения
- Административные операции

## Нагрузочные тесты

Нагрузочные тесты измеряют производительность API при различных уровнях нагрузки.

### Запуск нагрузочных тестов

Важно, что перед началом проведением данного теста необходимо запустить приложение - это можно сделать через собранный докер-образ. 
Существует два способа запуска нагрузочных тестов:

#### 1. Использование автоматизированного скрипта:

```bash
# Запуск тестов с настройками по умолчанию
python tests/load/run_load_test.py

# Указание хоста для тестирования
python tests/load/run_load_test.py --host http://localhost:9999

# Обработка существующих результатов тестов
python tests/load/run_load_test.py --process 20250402_230712
```

Скрипт выполнит:
- Умеренный нагрузочный тест (50 пользователей, скорость 5 пользователей/сек)
- Интенсивный нагрузочный тест (100 пользователей, скорость 10 пользователей/сек)
- Сгенерирует отчеты и графики для каждого теста

Здесь мы просто конструируем скрипт для командной строки при помощи питона, а затем сохраняем результаты в выходной текстовый файл для удобства анализа тестов.

#### 2. Использование веб-интерфейса Locust:

```bash
# Из корня проекта
locust -f tests/load/locustfile.py --host=http://localhost:9999
```

Затем откройте браузер по адресу http://localhost:8089 для настройки и запуска теста.

### Результаты нагрузочного тестирования

После запуска нагрузочных тестов, результаты будут доступны в следующих форматах:

1. **Консольный вывод**: Основные метрики будут выведены в терминал
   - Консольный вывод для приложения можно посмотреть по ссылке: [output.txt](https://github.com/bagagaga/hse-python-3rd-hw/blob/main/tests/load/output.txt)

2. **CSV-файлы**: Подробная статистика после запуска сохраняется в CSV-файлах в директории `load_test_results/`
   - `stats_[timestamp]_stats.csv`: Основная статистика тестов
   - `stats_[timestamp]_failures.csv`: Детали по неудачным запросам
   - `stats_[timestamp]_exceptions.csv`: Python-исключения во время теста
   - `stats_[timestamp]_stats_history.csv`: Временные ряды данных
В данном репозитории эти файлы опускаются за ненадобностью хранения и приводятся сразу в объединенном выходном файле.

## Покрытие кода тестами

Для проверки покрытия кода тестами:

```bash
# Запуск тестов с измерением покрытия
coverage run -m pytest tests/

# Вывод отчета о покрытии в консоль
coverage report

# Генерация HTML-отчета о покрытии
coverage html
```

После выполнения `coverage html`, откройте файл `htmlcov/index.html` в браузере для просмотра детального отчета о покрытии кода.

- Удобный вывод HTML-отчета доступен по ссылке: [report.html](https://html-preview.github.io/?url=https://github.com/bagagaga/hse-python-3rd-hw/blob/main/htmlcov/index.html) с 92% покрытием
